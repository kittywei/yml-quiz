<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>ç­”æ¡ˆ - äºæœ¦èƒ§é—®ç­”æŒ‘æˆ˜</title>
    <meta property="og:title" content="ç­”æ¡ˆ - äºæœ¦èƒ§é—®ç­”æŒ‘æˆ˜" />
    <meta
      property="og:description"
      content="æµ‹è¯•ä½ å¯¹äºæœ¦èƒ§çš„äº†è§£ç¨‹åº¦ï¼Œä¸€å…±5é¢˜ï¼Œç­”å¯¹è¶Šå¤šã€ç”¨æ—¶è¶ŠçŸ­æ’åè¶Šé å‰ï¼"
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:image"
      content="https://yml-quiz2.doudu.tech/images/yml-quiz-og-banner.jpg"
    />
    <meta property="og:locale" content="zh_CN" />
    <meta property="og:site_name" content="äºæœ¦èƒ§é—®ç­”æŒ‘æˆ˜" />
    <link rel="icon" href="https://yml-quiz.doudu.tech/images/favicon.ico" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
      /* --- å…¨å±€é‡ç½®ä¸å˜é‡ --- */
      :root {
        /* æš—å¤œæµå…‰ï¼ˆä½é¥±å’Œé«˜çº§ç°å˜è°ƒï¼‰ï¼šæ·±é’ -> æ·±è“ -> æ·±ç´« */
        --bg-gradient: linear-gradient(
          -45deg,
          #0f2027,
          #203a43,
          #2c5364,
          #24243e,
          #1f1c2c
        );

        /* æŸ æª¬æµå…‰ (å¼ºè°ƒè‰²) */
        --lemon-gradient: linear-gradient(135deg, #ffd700 0%, #f37335 100%);

        /* ç»ç’ƒè´¨æ„Ÿ */
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);

        /* æ–‡æœ¬è‰² */
        --text-main: #ffffff;
        --text-sub: #aab7c4;
      }

      [v-cloak] {
        display: none;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "PingFang SC", sans-serif;
        background: var(--bg-gradient);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        color: var(--text-main);
        min-height: 100vh;
        min-height: 100svh;
        min-height: 100dvh;
        height: 100%;
        overflow: hidden;
        display: flex;
        justify-content: center;
      }

      @keyframes gradientBG {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      #app {
        width: 100%;
        max-width: 480px;
        height: 100%;
        min-height: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.6);
        padding-bottom: env(safe-area-inset-bottom);
        box-sizing: border-box;
      }

      /* --- æ¼‚æµ®èƒŒæ™¯ --- */
      .lemon-bg {
        position: absolute;
        font-size: 10rem;
        opacity: 0.08;
        z-index: 0;
        pointer-events: none;
        filter: blur(5px);
        animation: float 8s infinite ease-in-out;
      }
      .lemon-1 {
        top: -40px;
        right: -40px;
      }
      .lemon-2 {
        bottom: -40px;
        left: -40px;
        animation-delay: 4s;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
        }
        50% {
          transform: translateY(30px) rotate(15deg);
        }
      }

      /* --- é¡µé¢é€šç”¨ --- */
      .screen {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 24px;
        position: relative;
        z-index: 1;
      }

      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.4s ease;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }

      /* --- 1. å¼€å§‹é¡µé¢ --- */
      .start-screen {
        justify-content: center;
        align-items: center;
        text-align: center;
      }

      .avatar-wrapper {
        position: relative;
        border-radius: 50%;
        padding: 6px;
        background: var(--lemon-gradient);
        box-shadow: 0 0 40px rgba(243, 115, 53, 0.4);
        margin-bottom: 30px;
      }
      .avatar-wrapper.large {
        width: 130px;
        height: 130px;
      }
      .avatar-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        background: #2e5e71;
        border: 3px solid #2e5e71;
        display: block;
      }

      .title {
        font-size: 2.2rem;
        margin-bottom: 10px;
        color: #fff;
        line-height: 1.2;
        font-weight: 800;
        text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .title span {
        background: var(--lemon-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 10px rgba(253, 200, 48, 0.3));
        font-size: 1.4em;
      }
      .subtitle {
        color: var(--text-sub);
        margin-bottom: 50px;
        font-size: 1.1rem;
        letter-spacing: 2px;
      }

      .btn-group {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
        padding: 0 20px;
        box-sizing: border-box;
      }
      .btn {
        padding: 16px 24px;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        border: none;
        transition: all 0.3s ease;
      }
      .btn:active {
        transform: scale(0.96);
      }
      .primary-btn {
        background: var(--lemon-gradient);
        color: #141e30;
        box-shadow: 0 4px 20px rgba(243, 115, 53, 0.3);
      }
      .outline-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
      }
      .full-width {
        width: 100%;
      }

      /* --- 2. ç­”é¢˜é¡µé¢ --- */
      .top-bar {
        margin-bottom: 40px;
      }
      .timer {
        font-family: monospace;
        font-size: 1.3rem;
        background: var(--lemon-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        margin-bottom: 30px;
        font-weight: bold;
      }
      .progress-track {
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        position: relative;
      }
      .progress-fill {
        height: 100%;
        background: var(--lemon-gradient);
        border-radius: 10px;
        transition: width 0.5s ease;
        box-shadow: 0 0 10px rgba(253, 200, 48, 0.5);
      }
      .progress-avatar {
        position: absolute;
        top: 50%;
        width: 36px;
        height: 36px;
        transform: translate(-50%, -50%);
        transition: left 0.5s ease;
        z-index: 2;
      }
      .progress-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid #fff;
      }

      .question-card {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .q-index {
        color: var(--text-sub);
        font-size: 0.9rem;
        letter-spacing: 2px;
        margin-bottom: 10px;
        text-transform: uppercase;
      }
      .q-text {
        font-size: 1.6rem;
        margin: 0 0 40px 0;
        color: #fff;
        font-weight: 700;
        line-height: 1.4;
      }
      .options-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .option-btn {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 20px;
        font-size: 1rem;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 120px;
        font-weight: 600;
      }
      .option-btn:not(:disabled):hover {
        border-color: #fdc830;
        background: rgba(253, 200, 48, 0.15);
        transform: translateY(-2px);
      }
      .option-btn.correct {
        border-color: #00b09b;
        background: rgba(0, 176, 155, 0.2);
        color: #96c93d;
      }
      .option-btn.wrong {
        border-color: #ff416c;
        background: rgba(255, 75, 31, 0.2);
        color: #ff416c;
      }
      .option-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .nav-controls {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
      }
      .nav-btn {
        font-size: 0.9rem;
        background: none;
        border: none;
        color: var(--text-sub);
        font-weight: bold;
        cursor: pointer;
        padding: 10px;
      }
      .nav-btn.next {
        color: #fdc830;
      }

      /* --- Modal å¼¹æ¡† --- */
      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 24px;
      }

      /* â˜…â˜…â˜… ä¿®æ”¹ç‚¹1ï¼šå¢åŠ  position: relative ä»¥ä¾¿å®šä½å…³é—­æŒ‰é’® */
      .modal {
        background: rgba(30, 30, 40, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 100%;
        border-radius: 30px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
        animation: popIn 0.4s ease;
        color: #fff;
        position: relative; /* å…³é”® */
      }
      @keyframes popIn {
        from {
          transform: scale(0.9) translateY(20px);
          opacity: 0;
        }
        to {
          transform: scale(1) translateY(0);
          opacity: 1;
        }
      }

      .lemon-icon {
        font-size: 3.5rem;
        margin-bottom: 15px;
        filter: drop-shadow(0 0 10px rgba(253, 200, 48, 0.5));
      }
      .score-display span {
        display: block;
        font-size: 3.5rem;
        margin: 10px 0;
        background: var(--lemon-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .input-name {
        width: 100%;
        padding: 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        border-radius: 15px;
        margin: 25px 0;
        font-size: 1.1rem;
        text-align: center;
        outline: none;
        box-sizing: border-box;
      }
      .input-name:focus {
        border-color: #fdc830;
      }

      /* --- æ’è¡Œæ¦œ (å«æˆ‘çš„æ’å) --- */
      .leaderboard-modal {
        text-align: left;
        height: 85%;
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        color: #fdc830;
      }

      /* åŸºç¡€å…³é—­æŒ‰é’®æ ·å¼ */
      .close-btn {
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        color: var(--text-sub);
      }

      /* â˜…â˜…â˜… ä¿®æ”¹ç‚¹2ï¼šä¸º Submit Modal å†…çš„å…³é—­æŒ‰é’®å¢åŠ ç‰¹å®šå®šä½ */
      .submit-modal .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 2rem;
        padding: 5px;
        line-height: 1;
      }
      .submit-modal .close-btn:hover {
        color: #fff;
      }

      /* æˆ‘çš„æ’åå¡ç‰‡ */
      .my-rank-card {
        background: rgba(253, 200, 48, 0.1); /* å¾®é»„è‰²èƒŒæ™¯ */
        border: 1px solid #fdc830;
        border-radius: 12px;
        padding: 15px 10px;
        margin-top: 10px;
        display: grid;
        grid-template-columns: 0.8fr 2fr 1fr 1fr;
        gap: 8px;
        align-items: center;
        box-shadow: 0 4px 15px rgba(253, 200, 48, 0.1);
      }
      .my-rank-label {
        grid-column: 1 / -1;
        font-size: 0.75rem;
        color: #fdc830;
        margin-bottom: 5px;
        font-weight: bold;
        letter-spacing: 1px;
        text-transform: uppercase;
      }
      .my-rank-card .user-name {
        color: #fff;
        font-weight: bold;
      }
      .my-rank-card .rank-num {
        font-size: 1.2rem;
        color: #fdc830;
        font-weight: 900;
      }

      /* åˆ—è¡¨å¤´ */
      .rank-header {
        display: grid;
        grid-template-columns: 0.8fr 2fr 1fr 1fr;
        gap: 8px;
        padding: 0 10px 10px 10px;
        color: var(--text-sub);
        font-size: 0.8rem;
        font-weight: bold;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 5px;
      }

      /* åˆ—è¡¨é¡¹ */
      .rank-list {
        list-style: none;
        padding: 0;
        overflow-y: auto;
        flex: 1;
      }
      .rank-item {
        display: grid;
        grid-template-columns: 0.8fr 2fr 1fr 1fr;
        gap: 8px;
        padding: 16px 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.95rem;
        align-items: center;
      }
      .top-3 .rank-num {
        font-size: 1.4rem;
      }
      .user-name {
        color: #fff;
        font-weight: bold;
      }
      .score {
        color: #fdc830;
        font-weight: bold;
      }
      .time {
        color: var(--text-sub);
        font-family: monospace;
      }

      .rank-list::-webkit-scrollbar {
        width: 4px;
      }
      .rank-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      /* --- éŸ³ä¹æŒ‰é’®æ ·å¼ --- */
      .music-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
        font-size: 1.2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        z-index: 200; /* ä¿è¯åœ¨æœ€é¡¶å±‚ */
        transition: all 0.3s ease;
        outline: none;
        backdrop-filter: blur(5px);
      }

      .music-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: scale(1.1);
      }

      .music-btn.playing {
        background: var(--lemon-gradient); /* æ’­æ”¾æ—¶å˜è‰² */
        border: none;
        box-shadow: 0 0 15px rgba(253, 200, 48, 0.6);
        animation: spin 3s linear infinite; /* æ—‹è½¬åŠ¨ç”» */
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .user-hint {
        font-size: 0.8rem;
        text-align: center;
        padding-bottom: 2rem;
        color: #637383;
      }
    </style>
    <script>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?386f463ae921f6d2ee23cfdab185140d";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  </head>
  <body>
    <div id="app" v-cloak>
      <audio ref="audioRef" loop src="images/daan.mp3"></audio>

      <button
        class="music-btn"
        :class="{ playing: isMusicPlaying }"
        @click="toggleMusic"
        title="èƒŒæ™¯éŸ³ä¹"
      >
        <span v-if="isMusicPlaying"
          ><svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            style="vertical-align: middle"
          >
            <path
              d="M9 18V5L21 3V16"
              stroke="#6c61a0"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M9 18V5L21 3V16C21 17.6569 19.6569 19 18 19C16.3431 19 15 17.6569 15 16C15 14.3431 16.3431 13 18 13C18.3456 13 18.6738 13.0583 18.9748 13.1656L19 13.175V5.88L11 7.21333V18C11 19.6569 9.65685 21 8 21C6.34315 21 5 19.6569 5 18C5 16.3431 6.34315 15 8 15C8.34557 15 8.67382 15.0583 8.97475 15.1656L9 15.175V18Z"
              fill="#6c61a0"
            />
          </svg>
        </span>
        <span v-else>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="24"
            height="24"
            fill="#cbc5d5"
            style="vertical-align: middle"
          >
            <path d="M0 0h24v24H0z" fill="none" />
            <path
              d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"
            />
          </svg>
        </span>
      </button>
      <div class="lemon-bg lemon-1">ğŸ‹</div>
      <div class="lemon-bg lemon-2">ğŸ‹</div>

      <transition name="fade" mode="out-in">
        <div
          v-if="gameState === 'start'"
          class="screen start-screen"
          key="start"
        >
          <div class="avatar-wrapper large">
            <img :src="personAvatar" alt="Person" class="avatar-img" />
          </div>
          <h1 class="title"><span>ç­”æ¡ˆ</span><br />äºæœ¦èƒ§é—®ç­”æŒ‘æˆ˜</h1>
          <p class="subtitle">
            æµ‹è¯•ä½ å¯¹äºæœ¦èƒ§çš„äº†è§£ç¨‹åº¦ï¼Œä¸€å…±5é¢˜ï¼Œç­”å¯¹è¶Šå¤šã€ç”¨æ—¶è¶ŠçŸ­æ’åè¶Šé å‰ï¼
          </p>

          <div class="btn-group">
            <button class="btn primary-btn" @click="startGame">å¼€å§‹æŒ‘æˆ˜</button>
            <button class="btn outline-btn" @click="openLeaderboard">
              æ’è¡Œæ¦œ ğŸ†
            </button>
          </div>
        </div>

        <div
          v-else-if="gameState === 'playing'"
          class="screen quiz-screen"
          key="quiz"
        >
          <div class="top-bar">
            <div class="timer">{{ formatTime(timer) }}</div>
            <div class="progress-track">
              <div
                class="progress-fill"
                :style="{ width: progressPercentage + '%' }"
              ></div>
              <div
                class="progress-avatar"
                :style="{ left: progressPercentage + '%' }"
              >
                <img :src="personAvatar" alt="marker" />
              </div>
            </div>
          </div>

          <div class="question-card">
            <span class="q-index">Question {{ currentQuestionIndex + 1 }}</span>
            <h2 class="q-text">{{ currentQuestion.text }}</h2>
            <div class="options-grid">
              <button
                v-for="(option, idx) in currentQuestion.options"
                :key="idx"
                class="option-btn"
                :class="getOptionClass(idx)"
                @click="handleAnswer(idx)"
                :disabled="currentQuestion.isAnswered"
              >
                <span class="opt-text">{{ option }}</span>
                <span
                  v-if="currentQuestion.isAnswered && idx === currentQuestion.correct"
                  class="icon"
                  >âœ…</span
                >
                <span
                  v-if="currentQuestion.isAnswered && idx === currentQuestion.selected && idx !== currentQuestion.correct"
                  class="icon"
                  >âŒ</span
                >
              </button>
            </div>
          </div>

          <div class="nav-controls">
            <button
              class="nav-btn"
              @click="prevQuestion"
              :disabled="currentQuestionIndex === 0"
            >
              ä¸Šä¸€é¢˜
            </button>
            <button class="nav-btn next" @click="nextQuestion">
              {{ isLastQuestion ? 'å®Œæˆç­”é¢˜' : 'ä¸‹ä¸€é¢˜' }}
            </button>
          </div>
        </div>
      </transition>

      <div class="user-hint">æ­¤ä¸ºçºªå¿µç¨‹åºï¼Œæ‰€æœ‰èµ„æºå‡æ¥æºäºç½‘ç»œå…¬å¼€èµ„æ–™ã€‚</div>
      <div v-if="showSubmitModal" class="modal-overlay">
        <div class="modal submit-modal">
          <button
            class="close-btn"
            @click="closeSubmit"
            title="ä¸æäº¤åˆ†æ•°ï¼Œè¿”å›é¦–é¡µ"
          >
            Ã—
          </button>

          <div class="lemon-icon">ğŸ‹</div>
          <h3>æŒ‘æˆ˜å®Œæˆï¼</h3>
          <div class="score-display">
            æ€»åˆ†
            <span>{{ score }}</span>
          </div>
          <p style="color: var(--text-sub); font-size: 0.9rem">
            ç”¨æ—¶ï¼š {{ formatTime(timer) }}
          </p>

          <input
            v-model="userName"
            type="text"
            placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°ï¼ˆ1-10ä¸ªå­—ï¼‰"
            class="input-name"
            maxlength="10"
          />
          <button class="btn primary-btn full-width" @click="submitResult">
            æäº¤åˆ†æ•°
          </button>
        </div>
      </div>

      <div v-if="showLeaderboard" class="modal-overlay">
        <div class="modal leaderboard-modal">
          <div class="modal-header">
            <h3>æ’è¡Œæ¦œ</h3>
            <button class="close-btn" @click="closeLeaderboard">Ã—</button>
          </div>

          <div class="rank-header">
            <span>æ’å</span><span>æ˜µç§°</span><span>åˆ†æ•°</span><span>ç”¨æ—¶</span>
          </div>

          <div v-if="userRankInfo" class="my-rank-card">
            <div class="my-rank-label">æˆ‘çš„æ’å</div>
            <span class="rank-num">{{ userRankInfo.rank }}</span>
            <span class="user-name">{{ userRankInfo.name }} </span>
            <span class="score">{{ userRankInfo.score }}</span>
            <span class="time">{{ userRankInfo.time }}</span>
          </div>
          <p
            v-if="leaderboard.length === 0"
            style="text-align: center; color: var(--text-sub)"
          >
            æš‚æ— æˆç»©è®°å½•ï¼Œå¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªå§ï¼
          </p>
          <ul class="rank-list">
            <li
              v-for="(item, index) in leaderboard"
              :key="index"
              class="rank-item"
              :class="{'top-3': index < 3}"
            >
              <span class="rank-num">
                {{ index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ?
                'ğŸ¥‰' : index + 1)) }}
              </span>
              <span class="user-name">{{ item.name }}</span>
              <span class="score">{{ item.score }}</span>
              <span class="time">{{ item.time }}</span>
            </li>
          </ul>

          <div v-if="gameState !== 'start'" style="margin-top: 20px">
            <button class="btn outline-btn full-width" @click="restartGame">
              å†ç©ä¸€æ¬¡
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="questions.js"></script>
    <script>
      const { createApp, ref, computed, onUnmounted } = Vue;
      const allQuestions = Array.isArray(window.questions)
        ? window.questions
        : [];
      const STORAGE_REMAINING_KEY = "yml_quiz_remaining_ids";

      const getAllQuestionIndices = () => allQuestions.map((_, idx) => idx);

      const shuffleInPlace = (arr) => {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
      };

      const loadRemainingIndices = () => {
        try {
          const raw = localStorage.getItem(STORAGE_REMAINING_KEY);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return null;
          const max = allQuestions.length;
          const seen = new Set();
          const cleaned = [];
          for (const value of parsed) {
            const idx = Number(value);
            if (!Number.isInteger(idx)) continue;
            if (idx < 0 || idx >= max) continue;
            if (seen.has(idx)) continue;
            seen.add(idx);
            cleaned.push(idx);
          }
          return cleaned;
        } catch (err) {
          console.warn("è¯»å–é¢˜åº“ç¼“å­˜å¤±è´¥:", err);
          return null;
        }
      };

      const saveRemainingIndices = (indices) => {
        try {
          localStorage.setItem(STORAGE_REMAINING_KEY, JSON.stringify(indices));
        } catch (err) {
          console.warn("ä¿å­˜é¢˜åº“ç¼“å­˜å¤±è´¥:", err);
        }
      };

      const buildQuestion = (q) => ({
        ...q,
        options: Array.isArray(q.options) ? q.options.slice() : [],
        selected: null,
        isAnswered: false,
      });

      createApp({
        setup() {
          // --- èµ„æº ---
          const personAvatar = ref("images/avatar.jpg");

          // --- æ¸¸æˆçŠ¶æ€ ---
          const gameState = ref("start");
          const showSubmitModal = ref(false);
          const showLeaderboard = ref(false);
          const userName = ref("");
          const timer = ref(0);
          let timerInterval = null;

          const userRankInfo = ref(null);

          // --- éŸ³ä¹æ§åˆ¶çŠ¶æ€ ---
          const audioRef = ref(null);
          const isMusicPlaying = ref(false);

          const toggleMusic = () => {
            const audio = audioRef.value;
            if (!audio) return;

            if (isMusicPlaying.value) {
              audio.pause();
              isMusicPlaying.value = false;
            } else {
              audio
                .play()
                .then(() => {
                  isMusicPlaying.value = true;
                })
                .catch((err) => {
                  console.error("æ’­æ”¾å¤±è´¥:", err);
                });
            }
          };

          // --- é¢˜ç›®æ•°æ® ---
          const questions = ref([]);
          let currentBatchIndices = [];

          const currentQuestionIndex = ref(0);
          const currentQuestion = computed(
            () =>
              questions.value[currentQuestionIndex.value] || {
                text: "",
                options: [],
                selected: null,
                isAnswered: false,
                correct: null,
              },
          );
          const isLastQuestion = computed(
            () => currentQuestionIndex.value === questions.value.length - 1,
          );

          const score = computed(() => {
            return (
              questions.value.filter((q) => q.selected === q.correct).length *
              20
            );
          });

          const progressPercentage = computed(() => {
            if (questions.value.length === 0) return 0;
            const answeredOffset =
              currentQuestion.value && currentQuestion.value.isAnswered ? 1 : 0;
            return (
              ((currentQuestionIndex.value + answeredOffset) /
                questions.value.length) *
              100
            );
          });

          // --- æ’è¡Œæ¦œæ•°æ® ---
          const leaderboard = ref([]);

          // --- æ–¹æ³• ---
          const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60)
              .toString()
              .padStart(2, "0");
            const s = (seconds % 60).toString().padStart(2, "0");
            return `${m}:${s}`;
          };

          const pickNextQuestions = (count) => {
            let remaining = loadRemainingIndices();
            if (!Array.isArray(remaining) || remaining.length === 0) {
              remaining = getAllQuestionIndices();
            }
            if (remaining.length === 0) {
              currentBatchIndices = [];
              return [];
            }

            const selected = [];
            if (remaining.length >= count) {
              const pool = remaining.slice();
              shuffleInPlace(pool);
              selected.push(...pool.slice(0, count));
            } else {
              selected.push(...remaining);
              const fullPool = getAllQuestionIndices().filter(
                (idx) => !selected.includes(idx),
              );
              shuffleInPlace(fullPool);
              const needed = count - selected.length;
              selected.push(
                ...fullPool.slice(0, Math.min(needed, fullPool.length)),
              );
            }

            currentBatchIndices = selected;
            return selected.map((idx) => buildQuestion(allQuestions[idx]));
          };

          const finalizeBatch = () => {
            if (currentBatchIndices.length === 0) return;
            let remaining = loadRemainingIndices();
            if (!Array.isArray(remaining) || remaining.length === 0) {
              remaining = getAllQuestionIndices();
            }
            const selectedSet = new Set(currentBatchIndices);
            const nextRemaining = remaining.filter(
              (idx) => !selectedSet.has(idx),
            );
            saveRemainingIndices(nextRemaining);
            currentBatchIndices = [];
          };

          const startGame = () => {
            currentQuestionIndex.value = 0;
            timer.value = 0;
            questions.value = pickNextQuestions(5);
            gameState.value = "playing";

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
              timer.value++;
            }, 1000);
          };

          const handleAnswer = (optionIndex) => {
            if (currentQuestion.value.isAnswered) return;
            currentQuestion.value.selected = optionIndex;
            currentQuestion.value.isAnswered = true;
          };

          const getOptionClass = (idx) => {
            const q = currentQuestion.value;
            if (!q.isAnswered) return "";
            if (idx === q.correct) return "correct";
            if (idx === q.selected && idx !== q.correct) return "wrong";
            return "disabled";
          };

          const nextQuestion = () => {
            if (isLastQuestion.value) {
              endGame();
            } else {
              currentQuestionIndex.value++;
            }
          };

          const prevQuestion = () => {
            if (currentQuestionIndex.value > 0) {
              currentQuestionIndex.value--;
            }
          };

          const endGame = () => {
            clearInterval(timerInterval);
            finalizeBatch();
            loadSavedName();
            showSubmitModal.value = true;
          };

          const fetchLeaderboard = async () => {
            try {
              const res = await fetch("/api/leaderboard");
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const data = await res.json();
              leaderboard.value = Array.isArray(data.leaderboard)
                ? data.leaderboard
                : [];
            } catch (err) {
              console.error("åŠ è½½æ’è¡Œæ¦œå¤±è´¥:", err);
              leaderboard.value = [];
            }
          };

          const openLeaderboard = async () => {
            await fetchLeaderboard();
            showLeaderboard.value = true;
          };

          const saveName = (name) => {
            const trimmed = name.trim();
            if (!trimmed) return;
            localStorage.setItem("yml_quiz_last_name", trimmed);
          };

          const loadSavedName = () => {
            const last = localStorage.getItem("yml_quiz_last_name");
            userName.value = last ? last : "";
          };

          const submitResult = async () => {
            if (!userName.value.trim()) {
              alert("è¯·è¾“å…¥æ˜µç§°");
              return;
            }

            const payload = {
              name: userName.value.trim(),
              score: score.value,
              timeSeconds: timer.value,
            };

            try {
              const res = await fetch("/api/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const data = await res.json();
              saveName(payload.name);

              leaderboard.value = Array.isArray(data.leaderboard)
                ? data.leaderboard
                : [];
              if (data.rank && data.entry) {
                userRankInfo.value = {
                  rank: data.rank,
                  name: data.entry.name,
                  score: data.entry.score,
                  time: data.entry.time,
                };
              } else {
                userRankInfo.value = null;
              }

              showSubmitModal.value = false;
              showLeaderboard.value = true;
              gameState.value = "finished";
            } catch (err) {
              console.error("æäº¤å¤±è´¥:", err);
              alert("æäº¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
            }
          };

          const restartGame = () => {
            showLeaderboard.value = false;
            loadSavedName();
            userRankInfo.value = null;
            gameState.value = "start";
          };

          // â˜…â˜…â˜… ä¿®æ”¹ç‚¹4ï¼šæ–°å¢å…³é—­æäº¤æ¡†çš„æ–¹æ³•
          const closeSubmit = () => {
            showSubmitModal.value = false;
            // å›åˆ°å¼€å§‹é¡µé¢
            restartGame();
          };

          const closeLeaderboard = () => {
            showLeaderboard.value = false;
            // å›åˆ°å¼€å§‹é¡µé¢
            restartGame();
          };

          onUnmounted(() => {
            if (timerInterval) clearInterval(timerInterval);
          });

          loadSavedName();
          fetchLeaderboard();

          return {
            personAvatar,
            gameState,
            showSubmitModal,
            showLeaderboard,
            userName,
            timer,
            questions,
            currentQuestionIndex,
            currentQuestion,
            isLastQuestion,
            score,
            progressPercentage,
            leaderboard,
            userRankInfo,
            formatTime,
            startGame,
            handleAnswer,
            getOptionClass,
            nextQuestion,
            prevQuestion,
            submitResult,
            openLeaderboard,
            closeLeaderboard,
            restartGame,
            audioRef,
            isMusicPlaying,
            toggleMusic,
            closeSubmit, // å¯¼å‡ºæ–°æ–¹æ³•
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
